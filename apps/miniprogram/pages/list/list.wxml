<!--pages/list/list.wxml-->
<view class="container">
  <!-- 背景图片区域 -->
  <view class="hero-section">
    <image 
      class="hero-image" 
      src="https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=800&h=300&fit=crop"
      mode="aspectFill"
    />
    <view class="hero-overlay">
      <view class="nav-header">
        <view class="nav-back" bindtap="onGoBack">
          <text class="back-arrow">←</text>
        </view>
        <view class="nav-placeholder"></view>
      </view>
      <text class="hero-title">New at HomeNest</text>
    </view>
  </view>

  <!-- 筛选标签栏 -->
  <view class="filter-bar">
    <scroll-view 
      class="filter-scroll" 
      scroll-x="{{true}}"
      enable-flex="{{true}}"
      show-scrollbar="{{false}}"
      scroll-with-animation="{{true}}"
    >
      <view class="filter-tags-container">
        <view class="filter-tag" bindtap="onQuickFilter" data-type="category">
          <text class="tag-text">商品分类</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="material">
          <text class="tag-text">材质选择</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="color">
          <text class="tag-text">颜色选择</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="style">
          <text class="tag-text">风格样式</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="size">
          <text class="tag-text">尺寸大小</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="price">
          <text class="tag-text">价格范围</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="brand">
          <text class="tag-text">品牌选择</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="condition">
          <text class="tag-text">成色等级</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="delivery">
          <text class="tag-text">配送方式</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="availability">
          <text class="tag-text">库存状态</text>
        </view>
        <view class="filter-tag" bindtap="onQuickFilter" data-type="discount">
          <text class="tag-text">优惠活动</text>
        </view>
        <!-- 全部筛选按钮放在最后 -->
        <view class="filter-all-btn" bindtap="onShowFilter">
          <text class="filter-icon">全部筛选</text>
          <text wx:if="{{hasActiveFilters}}" class="filter-badge">{{filterCount}}</text>
        </view>
        <!-- 添加额外的右边距确保最后一个元素可见 -->
        <view class="scroll-padding"></view>
      </view>
    </scroll-view>
  </view>

  <!-- 商品数量和视图切换 -->
  <view class="products-header">
    <text class="products-count">{{totalCount || items.length}} Products</text>
    <view class="view-toggle">
      <view class="toggle-btn active">
        <text class="toggle-icon">⊞</text>
      </view>
      <view class="toggle-btn">
        <text class="toggle-icon">☰</text>
      </view>
    </view>
  </view>

  <!-- 邮编和门店选择 -->
  <view class="location-bar">
    <view class="location-item" bindtap="onSelectPostcode">
      <text class="location-icon">🚚</text>
      <text class="location-text">Select post code</text>
    </view>
    <view class="location-item" bindtap="onSelectStore">
      <text class="location-icon">🏪</text>
      <text class="location-text">Select store</text>
    </view>
  </view>

  <!-- 骨架屏加载状态 -->
  <view wx:if="{{loading && items.length === 0}}" class="skeleton">
    <view class="skeleton-header"></view>
    <view class="skeleton-filters">
      <view class="skeleton-filter-btn"></view>
      <view class="skeleton-filter-btn"></view>
    </view>
    <view class="skeleton-products">
      <view wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this" class="skeleton-product"></view>
    </view>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error-state">
    <view class="error-icon">❌</view>
    <text class="error-message">{{error.message}}</text>
    <button wx:if="{{error.canRetry}}" class="retry-btn" bindtap="onRetryLoad">重试</button>
  </view>

  <!-- 空状态 -->
  <view wx:elif="{{isEmpty}}" class="empty-state">
    <view class="empty-icon">🔍</view>
    <text class="empty-message">没有找到相关商品</text>
    <text class="empty-desc">试试调整筛选条件</text>
    <button class="retry-btn" bindtap="onRetryLoad">重新搜索</button>
  </view>

  <!-- 有数据时显示内容 -->
  <view wx:else>
    <!-- 结果统计 -->
    <view class="result-info">
      <text class="result-text">
        共找到 {{total}} 个结果
        <text wx:if="{{searchQuery}}" class="search-keyword">"{{searchQuery}}"</text>
      </text>
    </view>

    <!-- 商品列表 - 2列网格布局 -->
    <view class="items-grid">
      <product-card
        wx:for="{{items}}" 
        wx:key="id"
        product="{{item}}"
        card-type="grid"
        show-favorite="{{true}}"
        bind:cardtap="onProductCardTap"
        bind:favoritechange="onFavoriteChange"
      />
    </view>

    <!-- 底部加载更多 -->
    <view wx:if="{{loading && items.length > 0}}" class="load-more">
      <text>加载更多...</text>
    </view>

    <!-- 没有更多 -->
    <view wx:elif="{{!hasMore && items.length > 0}}" class="no-more">
      <text>— 已显示全部商品 —</text>
    </view>

    <!-- 空状态 -->
    <view wx:if="{{items.length === 0}}" class="empty-state">
      <text class="empty-icon">📦</text>
      <text class="empty-text">
        {{searchQuery ? '没有找到相关商品' : '暂无商品'}}
      </text>
      <text class="empty-desc">
        {{searchQuery ? '试试修改搜索关键词' : '请稍后再试'}}
      </text>
    </view>
  </view>

  <!-- 新版筛选抽屉 -->
  <filter-sheet
    visible="{{showFilterSheet}}"
    schema="{{filterSchema}}"
    values="{{currentFilters}}"
    bind:apply="onFilterApply"
    bind:close="onFilterClose"
  />

  <!-- 单项筛选器组件 -->
  <single-filter
    visible="{{showSingleFilter}}"
    type="{{singleFilterType}}"
    title="{{singleFilterTitle}}"
    options="{{singleFilterOptions}}"
    selectedValues="{{singleFilterSelected}}"
    bind:apply="onSingleFilterApply"
    bind:close="onSingleFilterClose"
  />
</view>
