<!--pages/list/list.wxml-->
<view class="container theme-page">
  <!-- èƒŒæ™¯å›¾ï¼ˆHeroï¼‰ æ»¡å¹…è¦†ç›–ï¼Œè´´åˆé¡¶éƒ¨å®‰å…¨åŒº -->
  <view class="hero" style="--hero-url: url(https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=1200&h=600&fit=crop)">
    <view class="hero-overlay">
      <view class="nav-header">
        <view class="nav-back" bindtap="onGoBack">
          <text class="back-arrow">â†</text>
        </view>
        <view class="nav-placeholder"></view>
      </view>
      <text class="hero-title">New at HomeNest</text>
    </view>
  </view>

  <!-- ç­›é€‰æ ï¼šèƒ¶å›Šè¾¹æ¡†æ ·å¼ï¼Œæ¨ªå‘æ»šåŠ¨ -->
  <view class="filter-bar">
    <scroll-view scroll-x="true" enable-flex="true" class="filter-scroll">
      <view class="filter-row">
        <view class="filter-chip sort-chip" bindtap="onShowSort">æ’åºï¼š{{currentSortName}}</view>
        <view class="filter-chip {{currentFilters.category && currentFilters.category.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="category">å•†å“åˆ†ç±»</view>
        <view class="filter-chip {{currentFilters.material && currentFilters.material.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="material">æè´¨é€‰æ‹©</view>
        <view class="filter-chip {{currentFilters.color && currentFilters.color.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="color">é¢œè‰²é€‰æ‹©</view>
        <view class="filter-chip {{currentFilters.style && currentFilters.style.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="style">é£æ ¼æ ·å¼</view>
        <view class="filter-chip {{currentFilters.size && currentFilters.size.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="size">å°ºå¯¸å¤§å°</view>
        <view class="filter-chip {{currentFilters.price ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="price">ä»·æ ¼èŒƒå›´</view>
        <view class="filter-chip {{currentFilters.brand && currentFilters.brand.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="brand">å“ç‰Œé€‰æ‹©</view>
        <view class="filter-chip {{currentFilters.condition && currentFilters.condition.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="condition">æˆè‰²ç­‰çº§</view>
        <view class="filter-chip {{currentFilters.delivery && currentFilters.delivery.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="delivery">é…é€æ–¹å¼</view>
        <view class="filter-chip {{currentFilters.availability && currentFilters.availability.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="availability">åº“å­˜çŠ¶æ€</view>
        <view class="filter-chip {{currentFilters.discount && currentFilters.discount.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="discount">ä¼˜æƒ æ´»åŠ¨</view>
        <view class="filter-chip {{currentFilters.room && currentFilters.room.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="room">æˆ¿é—´ç±»å‹</view>
        <view class="filter-chip {{currentFilters.feature && currentFilters.feature.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="feature">ç‰¹æ®ŠåŠŸèƒ½</view>
        <view class="filter-chip {{currentFilters.warranty && currentFilters.warranty.length>0 ? 'is-active' : ''}}" bindtap="onQuickFilter" data-type="warranty">ä¿ä¿®æœŸé™</view>
        <view class="filter-chip filter-all {{hasActiveFilters ? 'is-active' : ''}}" bindtap="onShowFilter">
          å…¨éƒ¨ç­›é€‰
          <text wx:if="{{hasActiveFilters}}" class="filter-badge">{{filterCount}}</text>
        </view>
        <view wx:if="{{hasActiveFilters}}" class="filter-chip clear-filter" bindtap="clearAllFilters">
          æ¸…é™¤ç­›é€‰
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç­›é€‰ç»“æœæç¤º -->
  <view wx:if="{{hasActiveFilters}}" class="filter-result-tip">
    <text class="tip-text">å·²åº”ç”¨ç­›é€‰æ¡ä»¶ï¼Œå…±æ‰¾åˆ° {{items.length}} ä»¶å•†å“</text>
  </view>

  <!-- å•†å“æ•°é‡å’Œè§†å›¾åˆ‡æ¢ -->
  <view class="products-header">
    <text class="products-count">{{totalCount || items.length}} Products</text>
    <view class="view-toggle">
      <view class="toggle-btn {{viewMode === 'grid' ? 'active' : ''}}" bindtap="onToggleView" data-mode="grid">
        <text class="toggle-icon">âŠ</text>
      </view>
      <view class="toggle-btn {{viewMode === 'list' ? 'active' : ''}}" bindtap="onToggleView" data-mode="list">
        <text class="toggle-icon">â˜°</text>
      </view>
    </view>
  </view>

  

  <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading && items.length === 0}}" class="skeleton">
    <view class="skeleton-header"></view>
    <view class="skeleton-filters">
      <view class="skeleton-filter-btn"></view>
      <view class="skeleton-filter-btn"></view>
    </view>
    <view class="skeleton-products">
      <view wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this" class="skeleton-product"></view>
    </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-state">
    <view class="error-icon">âŒ</view>
    <text class="error-message">{{error.message}}</text>
    <button wx:if="{{error.canRetry}}" class="retry-btn" bindtap="onRetryLoad">é‡è¯•</button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{isEmpty}}" class="empty-state">
    <view class="empty-icon">ğŸ”</view>
    <text class="empty-message">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“</text>
    <text class="empty-desc">è¯•è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</text>
    <button class="retry-btn" bindtap="onRetryLoad">é‡æ–°æœç´¢</button>
  </view>

  <!-- æœ‰æ•°æ®æ—¶æ˜¾ç¤ºå†…å®¹ -->
  <view wx:else>
    <notify-banner id="nb" />
    <fav-burst id="fv" />
    <fly-ball id="ball" />


    <!-- å¤§å›¾åˆ—è¡¨ï¼ˆå®œå®¶é£ï¼Œé»˜è®¤æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{viewMode==='list'}}" class="lv-list">
      <block wx:for="{{items}}" wx:key="id">
                <view class="lv-card {{hasActiveFilters ? 'filtered-item' : ''}}" style="width:{{lvCardW}}rpx">
          <!-- å¤§å›¾ -->
          <view class="lv-hero" style="height:{{lvImgH}}rpx">
            <image class="lv-img" src="{{item.cover || item.image || (item.images && item.images[0] ? item.images[0].url : '')}}" mode="aspectFill" />
            <!-- å·¦ä¸Šè§’å¾½æ ‡ï¼šæˆè‰²/ä¿ƒé”€ -->
            <view wx:if="{{item._conditionText}}" class="lv-badge">{{item._conditionText}}</view>
            <!-- å³ä¸Šè§’æ”¶è— -->
            <button class="lv-fav" data-id="{{item.id}}" bindtap="onToggleFav" catchtap="onToggleFav">
              <text class="lv-ico">{{item.favored ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            </button>
          </view>

          <!-- ä¿¡æ¯åŒº -->
          <view class="lv-body">
            <view class="lv-title two-lines">{{item.title || item.name}}</view>
            <view class="lv-sub one-line" wx:if="{{item.brand || item.material || item.color}}">{{item.brand || 'LivingLux'}}, {{item.material || 'ç§‘æŠ€å¸ƒ'}}, {{item.color || 'ç°è‰²'}}</view>

            <view class="lv-price-row">
              <text class="lv-price">Â£{{item.rent_monthly_gbp || item.monthly || 8}}/mo</text>
            </view>

            <view class="lv-meta" wx:if="{{item.meta1 || item.meta2}}">
              <view class="lv-dot" wx:if="{{item.meta1}}">{{item.meta1}}</view>
              <view class="lv-dot" wx:if="{{item.meta2}}">{{item.meta2}}</view>
            </view>

            <view class="lv-opts" bindtap="onOptions" data-id="{{item.id}}" catchtap="onOptions">+ Options</view>
          </view>
        </view>
      </block>
    </view>

    <!-- åŸä¸¤åˆ—ç½‘æ ¼ï¼ˆä¿ç•™å¤‡ç”¨ï¼‰ -->
    <view wx:if="{{viewMode==='grid'}}" class="product-grid">
      <block wx:for="{{items}}" wx:key="id">
        <view class="new-product-card">
          <!-- å•†å“å›¾ç‰‡ -->
          <view class="product-image">
            <image class="product-img" src="{{item.cover || item.image || (item.images && item.images[0] ? item.images[0].url : '')}}" mode="aspectFill" />
            <!-- æˆè‰²å¾½ç«  -->
            <view wx:if="{{item._conditionText}}" class="condition-badge">{{item._conditionText}}</view>
            <!-- Best seller å¾½ç«  -->
            <view class="best-seller-badge" wx:if="{{item.isBestSeller}}">Best seller</view>
            <!-- æ”¶è—æŒ‰é’® -->
            <button class="favorite-btn {{item.favored ? 'favorited' : ''}}" data-id="{{item.id}}" bindtap="onToggleFav" catchtap="onToggleFav">
              <text class="heart-icon">{{item.favored ? 'â¤ï¸' : 'ğŸ¤'}}</text>
            </button>
          </view>
          
          <!-- å•†å“ä¿¡æ¯ -->
          <view class="product-info" bindtap="onProductCardTap" data-product="{{item}}">
            <view class="product-name">{{item.title || item.name}}</view>
            <view class="product-desc">{{item.brand || 'LivingLux'}}, {{item.material || 'ç§‘æŠ€å¸ƒ'}}, {{item.color || 'ç°è‰²'}}</view>
            
            <!-- ä»·æ ¼ -->
            <view class="price-section">
              <text class="price-text">Â£{{item.rent_monthly_gbp || item.monthly || 8}}/mo</text>
            </view>
            
            <!-- è¯„åˆ† -->
            <view class="rating-section">
              <view class="stars">
                <text class="star">â˜…</text>
                <text class="star">â˜…</text>
                <text class="star">â˜…</text>
                <text class="star">â˜…</text>
                <text class="star">â˜…</text>
              </view>
              <text class="review-count">({{item.reviewCount || 36}})</text>
            </view>
            
            <!-- é€‰é¡¹é“¾æ¥ -->
            <view class="options-link" bindtap="onOptions" data-id="{{item.id}}" catchtap="onOptions">+ Options</view>
          </view>
          

        </view>
      </block>
    </view>

    <!-- åº•éƒ¨åŠ è½½æ›´å¤š -->
    <view wx:if="{{loading && items.length > 0}}" class="load-more">
      <text>åŠ è½½æ›´å¤š...</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:elif="{{!hasMore && items.length > 0}}" class="no-more">
      <text>â€” å·²æ˜¾ç¤ºå…¨éƒ¨å•†å“ â€”</text>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{items.length === 0}}" class="empty-state">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">
        {{searchQuery ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³å•†å“' : 'æš‚æ— å•†å“'}}
      </text>
      <text class="empty-desc">
        {{searchQuery ? 'è¯•è¯•ä¿®æ”¹æœç´¢å…³é”®è¯' : 'è¯·ç¨åå†è¯•'}}
      </text>
    </view>
  </view>

  <!-- æ–°ç‰ˆç­›é€‰æŠ½å±‰ -->
  <filter-sheet
    visible="{{showFilterSheet}}"
    schema="{{filterSchema}}"
    values="{{currentFilters}}"
    bind:apply="onFilterApply"
    bind:close="onFilterClose"
  />

  <!-- å•é¡¹ç­›é€‰å™¨ç»„ä»¶ -->
  <single-filter
    visible="{{showSingleFilter}}"
    type="{{singleFilterType}}"
    title="{{singleFilterTitle}}"
    options="{{singleFilterOptions}}"
    selectedValues="{{singleFilterSelected}}"
    bind:apply="onSingleFilterApply"
    bind:close="onSingleFilterClose"
  />
</view>
