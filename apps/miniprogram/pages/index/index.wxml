<!--pages/index/index.wxml-->
<view class="container">
  <!-- å¤´å›¾ï¼ˆHeroï¼‰ æ»¡å¹…è¦†ç›– -->
  <view class="hero" style="--hero-url: url(https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=1200&h=600&fit=crop)"></view>
  <!-- éª¨æ¶å±åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="skeleton">
    <view class="skeleton-search"></view>
    <view class="skeleton-banner"></view>
    <view class="skeleton-categories">
      <view wx:for="{{[1,2,3,4]}}" wx:key="*this" class="skeleton-category"></view>
    </view>
    <view class="skeleton-products">
      <view wx:for="{{[1,2,3,4,5,6]}}" wx:key="*this" class="skeleton-product"></view>
    </view>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-state">
    <view class="error-icon">âŒ</view>
    <text class="error-message">{{error.message}}</text>
    <button wx:if="{{error.canRetry}}" class="retry-btn" bindtap="onRetryLoad">é‡è¯•</button>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:elif="{{isEmpty}}" class="empty-state">
    <view class="empty-icon">ğŸ“¦</view>
    <text class="empty-message">æš‚æ— æ•°æ®</text>
    <button class="retry-btn" bindtap="onRetryLoad">åˆ·æ–°</button>
  </view>

  <!-- æ­£å¸¸å†…å®¹ -->
  <view wx:else>
    <!-- æœç´¢æ¡† -->
    <view class="search-bar">
      <view class="search-input" bindtap="onSearchTap">
        <text class="search-icon">ğŸ”</text>
        <text class="search-placeholder">æœç´¢å®¶å…·...</text>
      </view>
      <!-- ä¸´æ—¶ç®¡ç†å…¥å£ - é•¿æŒ‰5ç§’æ˜¾ç¤º -->
      <view class="admin-trigger" bindlongpress="onAdminAccess"></view>
    </view>

    <!-- è½®æ’­å›¾ï¼ˆä¿ç•™ï¼Œå¯ä¸‹ç§»ï¼‰ -->
    <swiper class="banner-swiper" indicator-dots="true" autoplay="true" interval="4000" duration="500">
      <swiper-item wx:for="{{banners}}" wx:key="id" data-banner="{{item}}" bindtap="onBannerTap">
        <image class="banner-image" src="{{item.image}}" mode="aspectFill"></image>
        <view class="banner-overlay">
          <text class="banner-title">{{item.title}}</text>
        </view>
      </swiper-item>
    </swiper>

    <!-- åˆ†ç±»å¯¼èˆª -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">å•†å“åˆ†ç±»</text>
        <text class="view-more" bindtap="onToggleCats">{{showAllCats ? 'æ”¶èµ·' : 'æŸ¥çœ‹æ›´å¤š >'}}</text>
      </view>
      <view class="categories">
        <view 
          wx:for="{{displayCats}}" 
          wx:key="id" 
          class="cat"
          data-name="{{item.name}}"
          bindtap="onTapCategory"
        >
          <view class="category-icon">{{item.icon}}</view>
          <text class="category-name">{{item.name}}</text>
          <text class="category-count">({{item.count}})</text>
        </view>
      </view>
    </view>

    <!-- å•†å“ç»Ÿè®¡ -->
    <view class="results-summary">
      <text class="results-text">å…± {{totalCount}} ä»¶å•†å“</text>
    </view>

    <!-- çƒ­é—¨å•†å“ -->
    <view class="section">
      <view class="section-header">
        <text class="section-title">çƒ­é—¨å•†å“</text>
        <text class="view-more" bindtap="onViewMoreHot">æŸ¥çœ‹æ›´å¤š ></text>
      </view>
      <view class="product-grid">
        <block wx:for="{{hotItems}}" wx:key="id">
          <view class="new-product-card">
            <!-- å•†å“å›¾ç‰‡ -->
            <view class="product-image" bindtap="onProductCardTap" data-product="{{item}}">
              <image class="product-img" src="{{item.cover || item.image || (item.images && item.images[0] ? item.images[0].url : '')}}" mode="aspectFill" />
              <!-- æˆè‰²å¾½ç«  -->
              <view wx:if="{{item._conditionText}}" class="condition-badge">{{item._conditionText}}</view>
              <!-- Best seller å¾½ç«  -->
              <view class="best-seller-badge" wx:if="{{item.isBestSeller}}">Best seller</view>
              <!-- æ”¶è—æŒ‰é’® -->
              <button class="favorite-btn {{item.favored ? 'favorited' : ''}}" data-id="{{item.id}}" bindtap="onToggleFav" catchtap="onToggleFav">
                <text class="heart-icon">{{item.favored ? 'â¤ï¸' : 'ğŸ¤'}}</text>
              </button>
            </view>
            
            <!-- å•†å“ä¿¡æ¯ -->
            <view class="product-info" bindtap="onProductCardTap" data-product="{{item}}">
              <view class="product-name">{{item.title || item.name}}</view>
              <view class="product-desc">{{item.brand || 'LivingLux'}}, {{item.material || 'ç§‘æŠ€å¸ƒ'}}, {{item.color || 'ç°è‰²'}}</view>
              
              <!-- ä»·æ ¼ -->
              <view class="price-section">
                <!-- ä»·æ ¼æ¨¡å¼ -->
                <view wx:if="{{item.priceInfo.mode !== 'ask'}}" class="price-row">
                  <text class="price-text">Â£{{item.formattedPrice || (item.rent_monthly_gbp || item.monthly || 8)}}/mo</text>
                </view>
                
                <!-- å’¨è¯¢æ¨¡å¼ -->
                <view wx:else class="consult-container">
                  <button class="ask-price-btn" bindtap="onPriceInquiry" data-product="{{item}}">
                    å’¨è¯¢ä»·æ ¼
                  </button>
                </view>
              </view>
              
              <!-- è¯„åˆ† -->
              <view class="rating-section">
                <view class="stars">
                  <text class="star">â˜…</text>
                  <text class="star">â˜…</text>
                  <text class="star">â˜…</text>
                  <text class="star">â˜…</text>
                  <text class="star">â˜…</text>
                </view>
                <text class="review-count">({{item.reviewCount || 36}})</text>
              </view>
              
              <!-- é€‰é¡¹é“¾æ¥ -->
              <view class="options-link" bindtap="onOptions" data-id="{{item.id}}" catchtap="onOptions">+ Options</view>
            </view>
          </view>
                 </block>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view wx:if="{{hotItems.length === 0}}" class="empty-hot-items">
        <text class="empty-text">æš‚æ— çƒ­é—¨å•†å“</text>
      </view>
    </view>
  </view>
</view>

<!-- é¦–æ¬¡è¿›å…¥å¼•å¯¼ç™»å½•å¼¹çª— -->
<view wx:if="{{showAuthModal}}" class="auth-mask">
  <view class="auth-modal">
    <text class="auth-title">æ¬¢è¿ä½¿ç”¨</text>
    <text class="auth-sub">è¯·ç™»å½•å¹¶è®¾ç½®å¤´åƒä¸æ˜µç§°</text>
    <button class="avatar-choose" open-type="chooseAvatar" bindchooseavatar="onChooseAuthAvatar" hover-class="none">
      <block wx:if="{{authAvatar}}">
        <image class="auth-avatar {{authAvatarError ? 'invalid' : ''}}" src="{{authAvatar}}" mode="aspectFill" />
      </block>
      <block wx:else>
        <view class="auth-avatar placeholder {{authAvatarError ? 'invalid' : ''}}">
          <text class="avatar-placeholder-icon">ğŸ‘¤</text>
        </view>
      </block>
    </button>
    <text class="auth-tip">ç‚¹å‡»å¤´åƒæˆæƒ</text>
    <input class="auth-input {{authNickError ? 'invalid' : ''}}" placeholder="è¾“å…¥æ˜µç§°ï¼ˆå¿…å¡«ï¼‰" value="{{authNickname}}" bindinput="onAuthInputNick"/>
    <view class="auth-actions">
      <button class="auth-skip" bindtap="onAuthSkip">æš‚ä¸ç™»å½•</button>
      <button class="auth-login" bindtap="onAuthLogin">ç«‹å³ç™»å½•</button>
    </view>
  </view>
  <view class="auth-safe"/>
</view>
