<!--pages/detail/detail.wxml-->
<view class="container theme-page">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <text>加载中...</text>
  </view>

  <!-- 错误状态 -->
  <view wx:elif="{{error}}" class="error">
    <text>{{error}}</text>
    <button class="btn-primary" bindtap="onRetry">重试</button>
  </view>

  <!-- 商品详情内容 -->
  <view wx:elif="{{sku}}" class="detail-content">
    <notify-banner id="nb" />
    <fav-burst id="fv" />
    <fly-ball id="ball" />
    <!-- 图片展示 -->
    <view class="image-section">
      <image 
        class="main-image" 
        src="{{sku.images[selectedImage].url || sku.images[selectedImage] || 'https://picsum.photos/400/300?random=0'}}" 
        mode="aspectFill"
        bindtap="onImagePreview"
      ></image>
      <!-- 收藏按钮 -->
      <button class="favorite-btn {{isFavorited ? 'favorited' : ''}}" bindtap="onToggleFavorite">
        <text class="heart-icon">{{isFavorited ? '❤️' : '🤍'}}</text>
      </button>
    </view>

    <!-- 商品基本信息 -->
    <view class="info-section">
      <view class="product-header">
        <view class="product-left">
          <text class="sku-name">{{sku.title || sku.name}}</text>
          <view class="price-container">
            <text class="sku-price">£{{formattedPrice}}/mo</text>
            <text class="msrp-text">MSRP £{{sku.msrp || sku.purchase_price_gbp || '299'}}</text>
          </view>
        </view>
        <view class="product-divider"></view>
        <view class="product-right">
          <view class="rating-info" bindtap="onRatingTap">
            <text class="rating-score">4.99</text>
            <view class="stars">
              <text class="star">★</text>
              <text class="star">★</text>
              <text class="star">★</text>
              <text class="star">★</text>
              <text class="star">★</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="divider"></view>
      
      <!-- 商品介绍 -->
      <view class="product-intro-section">
        <text class="section-title">商品介绍</text>
        <view class="product-description">
          <text class="description-content">{{sku.description || sku.desc || '这款商品采用优质材料制作，设计简约时尚，适合现代家居环境。产品经过严格质量检测，确保安全可靠。'}}</text>
        </view>

        <!-- 商品属性 -->
        <view class="sku-attributes">
          <view class="attribute">
            <text class="attr-label">分类：</text>
            <text class="attr-value">{{sku.category ? sku.category.join(' / ') : ''}}</text>
          </view>
          <view class="attribute">
            <text class="attr-label">风格：</text>
            <text class="attr-value">{{sku.style ? sku.style.join('、') : ''}}</text>
          </view>
          <view class="attribute">
            <text class="attr-label">材质：</text>
            <text class="attr-value">{{sku.material ? sku.material.join('、') : ''}}</text>
          </view>
          <view class="attribute">
            <text class="attr-label">颜色：</text>
            <text class="attr-value">{{sku.color ? sku.color.join('、') : ''}}</text>
          </view>
        </view>
        
        <!-- 尺寸信息 -->
        <view class="dimensions-section">
          <view class="dimensions-title">尺寸信息</view>
          <view class="dimensions-content">
            <text class="dimensions-text">{{sku.dimensions || '120 × 80 × 45 cm'}}</text>
          </view>
        </view>
      </view>
      
      <view class="divider"></view>

      <!-- 价格盒子移除：避免重复价格展示，仅在“费用明细”展示 -->


    </view>



    <!-- 租期选择器 -->
    <view class="rental-config">
      <view class="section-header">
        <text class="section-title">租赁配置</text>
      </view>
      
      <!-- 租期单位选择 -->
      <view class="config-item">
        <text class="config-label">租期单位</text>
        <radio-group class="radio-group" bindchange="onDurationUnitChange">
          <label class="radio-item">
            <radio value="0" checked="{{durationUnit === 'week'}}" />
            <text class="radio-text">按周租</text>
          </label>
          <label class="radio-item">
            <radio value="1" checked="{{durationUnit === 'month'}}" />
            <text class="radio-text">按月租</text>
          </label>
        </radio-group>
      </view>

      <!-- 租期时长 -->
      <view class="config-item">
        <text class="config-label">租期时长</text>
        <view class="duration-selector">
          <view class="duration-input">
            <input 
              type="number" 
              value="{{duration}}" 
              bindinput="onDurationChange"
              class="duration-number"
              placeholder="1"
              min="1"
              max="{{durationUnit === 'week' ? 52 : 12}}"
            />
            <text class="duration-unit">{{durationUnit === 'week' ? '周' : '月'}}</text>
          </view>
        </view>
        <text class="hint-text text-muted">满3/6/12个月享95/90/85折，已自动计算。</text>
      </view>

      <!-- 数量选择 -->
      <view class="config-item">
        <text class="config-label">租赁数量</text>
        <view class="quantity-selector">
          <button class="qty-btn" bindtap="onQuantityDecrease">-</button>
          <input 
            type="number" 
            value="{{quantity}}" 
            bindinput="onQuantityChange"
            class="qty-input"
            min="1"
          />
          <button class="qty-btn" bindtap="onQuantityIncrease">+</button>
        </view>
      </view>

      <!-- 配送城市选择 -->
      <view class="config-item">
        <text class="config-label">配送城市</text>
        <view class="city-selector">
          <view class="city-input" bindtap="onCitySelect">
            <text class="city-text">
              {{selectedCity || '请选择配送城市'}}
            </text>
            <text class="city-arrow">⌄</text>
          </view>
          <view wx:if="{{deliveryInfo && selectedCity}}" class="delivery-eta">
            <text class="eta-text" wx:if="{{selectedCity === 'Durham'}}">
              预计当天或隔天送达
            </text>
            <text class="eta-text" wx:elif="{{selectedCity === 'Newcastle' || selectedCity === 'Sunderland'}}">
              预计2-3天送达
            </text>
            <text class="eta-text" wx:else>
              预计{{deliveryInfo.etaDays[0]}}-{{deliveryInfo.etaDays[1]}}天送达
            </text>
          </view>
        </view>
      </view>

      <!-- 可选服务 -->
      <view class="config-item">
        <text class="config-label">增值服务</text>
        <view class="services-list">
          <view 
            wx:for="{{availableServices}}" 
            wx:key="id"
            class="service-item {{item.selected ? 'selected' : ''}}"
            data-service-id="{{item.id}}"
            bindtap="onServiceChange"
          >
            <view class="service-info">
              <text class="service-name">{{item.name}}</text>
              <text wx:if="{{item.note}}" class="service-note">{{item.note}}</text>
            </view>
            <view class="service-price">
              <text wx:if="{{item.price > 0}}">¥{{item.price}}</text>
              <text wx:else>动态计算</text>
            </view>
            <view class="service-check">
              <text class="check-icon">{{item.selected ? '✓' : '○'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 报价明细 -->
    <view wx:if="{{quoteData}}" class="quote-section">
      <view class="section-header">
        <text class="section-title">费用明细</text>
      </view>
      
      <view class="quote-breakdown">
        <!-- 基础费用 -->
        <view class="quote-item">
          <text class="quote-label">{{quoteData.breakdown.unitPriceLabel}}</text>
          <text class="quote-value">£{{quoteData.breakdown.unitPrice}}/mo</text>
        </view>
        
        <view class="quote-item">
          <text class="quote-label">{{quoteData.breakdown.baseRentLabel}}</text>
          <text class="quote-value">£{{quoteData.breakdown.baseRent}}</text>
        </view>

        <!-- 服务费用 -->
        <view wx:if="{{quoteData.breakdown.services.length > 0}}" class="quote-services">
          <view 
            wx:for="{{quoteData.breakdown.services}}" 
            wx:key="id"
            class="quote-item service-item"
          >
            <text class="quote-label">{{item.name}}</text>
            <text class="quote-value">£{{item.price}}</text>
          </view>
        </view>

        <!-- 优惠折扣 -->
        <view wx:if="{{quoteData.breakdown.discount > 0}}" class="quote-item discount">
          <text class="quote-label">{{quoteData.breakdown.discountReason}}</text>
          <text class="quote-value discount-value">-¥{{quoteData.breakdown.discount}}</text>
        </view>

        <!-- 押金 -->
        <view class="quote-item deposit">
          <text class="quote-label">{{quoteData.breakdown.depositReason}}</text>
          <text class="quote-value">£{{quoteData.breakdown.deposit}}</text>
        </view>

        <!-- 分割线 -->
        <view class="quote-divider"></view>

        <!-- 小计 -->
        <view class="quote-item subtotal">
          <text class="quote-label">{{quoteData.breakdown.totalRentLabel}}</text>
          <text class="quote-value">£{{quoteData.breakdown.totalRent}}</text>
        </view>

        <!-- 总计 -->
        <view class="quote-item total">
          <text class="quote-label">{{quoteData.breakdown.grandTotalLabel}}</text>
          <text class="quote-value total-value">£{{quoteData.breakdown.grandTotal}}</text>
        </view>
      </view>

      <!-- 计算说明 -->
      <view class="quote-note">
        <text class="note-text">{{quoteData.calculation.note}}</text>
      </view>
    </view>

    <!-- 意向单操作 -->
    <view wx:if="{{FEATURE_INTENT}}" class="intent-actions">
      <button class="intent-btn secondary-btn" bindtap="onAddToIntent">加入意向单</button>
      <button class="intent-btn primary-btn" bindtap="onSubmitIntent">立即提交意向</button>
    </view>

    <!-- 报价加载状态 -->
    <view wx:elif="{{quoteLoading}}" class="quote-loading">
      <text>计算报价中...</text>
    </view>

    <!-- 报价错误状态 -->
    <view wx:elif="{{quoteError}}" class="quote-error">
      <text>{{quoteError}}</text>
      <button class="retry-btn" bindtap="calculateQuote">重新计算</button>
    </view>



    

    

    <!-- 保养说明 -->
    <view wx:if="{{sku.care}}" class="care-section">
      <text class="section-title">保养说明</text>
      <text class="care-content">{{sku.care}}</text>
    </view>

    <!-- 常见问题 -->
    <view wx:if="{{sku.faq && sku.faq.length > 0}}" class="faq-section">
      <text class="section-title">常见问题</text>
      <view class="faq-list">
        <view wx:for="{{sku.faq}}" wx:key="q" class="faq-item">
          <text class="faq-question">Q: {{item.q}}</text>
          <text class="faq-answer">A: {{item.a}}</text>
        </view>
      </view>
    </view>

    <!-- 推荐商品 -->
    <view wx:if="{{recommendations.length > 0}}" class="recommendations-section">
      <text class="section-title">相关推荐</text>
      <scroll-view class="recommendations-scroll" scroll-x="true">
        <product-card
          wx:for="{{recommendations}}" 
          wx:key="id"
          product="{{item}}"
          card-type="grid"
          show-favorite="{{true}}"
          bind:cardtap="onRecommendationTap"
        />
      </scroll-view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view wx:if="{{sku}}" class="bottom-actions">
    <button class="cart-btn" bindtap="onAddToCart">加入购物车</button>
  </view>

  <!-- 尺寸示意图弹窗 -->
  <size-sketch
    visible="{{showSizeGuide}}"
    product="{{sku}}"
    mode="modal"
    bind:close="onHideSizeGuide"
  />
</view>
