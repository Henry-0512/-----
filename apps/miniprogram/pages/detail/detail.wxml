<!--pages/detail/detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error">
    <text>{{error}}</text>
    <button class="btn-primary" bindtap="onRetry">é‡è¯•</button>
  </view>

  <!-- å•†å“è¯¦æƒ…å†…å®¹ -->
  <view wx:elif="{{sku}}" class="detail-content">
    <!-- å›¾ç‰‡å±•ç¤º -->
    <view class="image-section">
      <image 
        class="main-image" 
        src="{{sku.images[selectedImage].url || sku.images[selectedImage] || 'https://picsum.photos/400/300?random=0'}}" 
        mode="aspectFill"
        bindtap="onImagePreview"
      ></image>
      <view class="image-indicators">
        <view 
          wx:for="{{sku.images}}" 
          wx:key="*this" 
          class="indicator {{index === selectedImage ? 'active' : ''}}"
          data-index="{{index}}"
          bindtap="onImageSelect"
        ></view>
      </view>
    </view>

    <!-- å•†å“åŸºæœ¬ä¿¡æ¯ -->
    <view class="info-section">
      <text class="sku-name">{{sku.title || sku.name}}</text>
      <text class="sku-brand">{{sku.brand}}</text>
      
      <view class="price-info">
        <!-- æ™®é€šä»·æ ¼æ˜¾ç¤ºæ¨¡å¼ -->
        <view wx:if="{{priceInfo.mode !== 'ask'}}">
          <text class="monthly-price">{{priceInfo.display}}</text>
          <text wx:if="{{priceInfo.originalPrice}}" class="original-price">{{priceInfo.originalPrice}}</text>
        </view>
        
        <!-- å’¨è¯¢ä»·æ ¼æ¨¡å¼ -->
        <view wx:else class="price-inquiry-section">
          <text class="inquiry-text">{{priceInfo.display}}</text>
          <button class="inquiry-btn-detail" bindtap="onPriceInquiry">
            {{priceInfo.buttonText}}
          </button>
        </view>
      </view>

      <view class="sku-attributes">
        <view class="attribute">
          <text class="attr-label">åˆ†ç±»ï¼š</text>
          <text class="attr-value">{{sku.category ? sku.category.join(' / ') : ''}}</text>
        </view>
        <view class="attribute">
          <text class="attr-label">é£æ ¼ï¼š</text>
          <text class="attr-value">{{sku.style ? sku.style.join('ã€') : ''}}</text>
        </view>
        <view class="attribute">
          <text class="attr-label">æè´¨ï¼š</text>
          <text class="attr-value">{{sku.material ? sku.material.join('ã€') : ''}}</text>
        </view>
        <view class="attribute">
          <text class="attr-label">é¢œè‰²ï¼š</text>
          <text class="attr-value">{{sku.color ? sku.color.join('ã€') : ''}}</text>
        </view>
      </view>

      <!-- åº“å­˜å’Œé…é€ä¿¡æ¯ -->
      <view class="availability-info">
        <view class="stock-info">
          <text class="stock-label">åº“å­˜ï¼š</text>
          <text class="stock-value {{(sku.stock && sku.stock[0] && sku.stock[0].qty > 0) ? 'in-stock' : 'out-of-stock'}}">
            {{(sku.stock && sku.stock[0]) ? (sku.stock[0].qty > 0 ? 'ç°è´§ ' + sku.stock[0].qty + ' ä»¶' : 'æš‚æ—¶ç¼ºè´§') : 'æš‚æ—¶ç¼ºè´§'}}
          </text>
        </view>
        
        <!-- é¢„è®¡åˆ°è´§æ—¶é—´ -->
        <view wx:if="{{sku.delivery && sku.delivery.eta_days}}" class="eta-info">
          <text class="eta-label">é¢„è®¡é€è¾¾ï¼š</text>
          <text class="eta-value">{{sku.delivery.eta_days[0]}}-{{sku.delivery.eta_days[1]}}å¤©</text>
        </view>
      </view>

      <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
      <view class="quick-actions">
        <button class="action-btn secondary-btn" bindtap="onAddToCompare">
          <text class="btn-icon">âš–</text>
          <text class="btn-text">å¯¹æ¯”</text>
        </button>
        <button class="action-btn secondary-btn" bindtap="onToggleFavorite">
          <text class="btn-icon">{{isFavorited ? 'â™¥' : 'â™¡'}}</text>
          <text class="btn-text">{{isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
        </button>
        <button class="action-btn primary-btn" bindtap="onAddToCart">
          <text class="btn-icon">ğŸ›’</text>
          <text class="btn-text">åŠ å…¥è´­ç‰©è½¦</text>
        </button>
      </view>
    </view>

    <!-- ç§ŸæœŸé€‰æ‹©å™¨ -->
    <view class="rental-config">
      <view class="section-header">
        <text class="section-title">ç§Ÿèµé…ç½®</text>
      </view>
      
      <!-- ç§ŸæœŸå•ä½é€‰æ‹© -->
      <view class="config-item">
        <text class="config-label">ç§ŸæœŸå•ä½</text>
        <radio-group class="radio-group" bindchange="onDurationUnitChange">
          <label class="radio-item">
            <radio value="0" checked="{{durationUnit === 'week'}}" />
            <text class="radio-text">æŒ‰å‘¨ç§Ÿ</text>
          </label>
          <label class="radio-item">
            <radio value="1" checked="{{durationUnit === 'month'}}" />
            <text class="radio-text">æŒ‰æœˆç§Ÿ</text>
          </label>
        </radio-group>
      </view>

      <!-- ç§ŸæœŸæ—¶é•¿ -->
      <view class="config-item">
        <text class="config-label">ç§ŸæœŸæ—¶é•¿</text>
        <view class="duration-selector">
          <view class="duration-input">
            <input 
              type="number" 
              value="{{duration}}" 
              bindinput="onDurationChange"
              class="duration-number"
              placeholder="1"
              min="1"
              max="{{durationUnit === 'week' ? 52 : 12}}"
            />
            <text class="duration-unit">{{durationUnit === 'week' ? 'å‘¨' : 'æœˆ'}}</text>
          </view>
        </view>
      </view>

      <!-- æ•°é‡é€‰æ‹© -->
      <view class="config-item">
        <text class="config-label">ç§Ÿèµæ•°é‡</text>
        <view class="quantity-selector">
          <button class="qty-btn" bindtap="onQuantityDecrease">-</button>
          <input 
            type="number" 
            value="{{quantity}}" 
            bindinput="onQuantityChange"
            class="qty-input"
            min="1"
          />
          <button class="qty-btn" bindtap="onQuantityIncrease">+</button>
        </view>
      </view>

      <!-- å¯é€‰æœåŠ¡ -->
      <view class="config-item">
        <text class="config-label">å¢å€¼æœåŠ¡</text>
        <view class="services-list">
          <view 
            wx:for="{{availableServices}}" 
            wx:key="id"
            class="service-item {{item.selected ? 'selected' : ''}}"
            data-service-id="{{item.id}}"
            bindtap="onServiceChange"
          >
            <view class="service-info">
              <text class="service-name">{{item.name}}</text>
              <text wx:if="{{item.note}}" class="service-note">{{item.note}}</text>
            </view>
            <view class="service-price">
              <text wx:if="{{item.price > 0}}">Â¥{{item.price}}</text>
              <text wx:else>åŠ¨æ€è®¡ç®—</text>
            </view>
            <view class="service-check">
              <text class="check-icon">{{item.selected ? 'âœ“' : 'â—‹'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æŠ¥ä»·æ˜ç»† -->
    <view wx:if="{{quoteData}}" class="quote-section">
      <view class="section-header">
        <text class="section-title">è´¹ç”¨æ˜ç»†</text>
      </view>
      
      <view class="quote-breakdown">
        <!-- åŸºç¡€è´¹ç”¨ -->
        <view class="quote-item">
          <text class="quote-label">{{quoteData.breakdown.unitPriceLabel}}</text>
          <text class="quote-value">Â¥{{quoteData.breakdown.unitPrice}}</text>
        </view>
        
        <view class="quote-item">
          <text class="quote-label">{{quoteData.breakdown.baseRentLabel}}</text>
          <text class="quote-value">Â¥{{quoteData.breakdown.baseRent}}</text>
        </view>

        <!-- æœåŠ¡è´¹ç”¨ -->
        <view wx:if="{{quoteData.breakdown.services.length > 0}}" class="quote-services">
          <view 
            wx:for="{{quoteData.breakdown.services}}" 
            wx:key="id"
            class="quote-item service-item"
          >
            <text class="quote-label">{{item.name}}</text>
            <text class="quote-value">Â¥{{item.price}}</text>
          </view>
        </view>

        <!-- ä¼˜æƒ æŠ˜æ‰£ -->
        <view wx:if="{{quoteData.breakdown.discount > 0}}" class="quote-item discount">
          <text class="quote-label">{{quoteData.breakdown.discountReason}}</text>
          <text class="quote-value discount-value">-Â¥{{quoteData.breakdown.discount}}</text>
        </view>

        <!-- æŠ¼é‡‘ -->
        <view class="quote-item deposit">
          <text class="quote-label">{{quoteData.breakdown.depositReason}}</text>
          <text class="quote-value">Â¥{{quoteData.breakdown.deposit}}</text>
        </view>

        <!-- åˆ†å‰²çº¿ -->
        <view class="quote-divider"></view>

        <!-- å°è®¡ -->
        <view class="quote-item subtotal">
          <text class="quote-label">{{quoteData.breakdown.totalRentLabel}}</text>
          <text class="quote-value">Â¥{{quoteData.breakdown.totalRent}}</text>
        </view>

        <!-- æ€»è®¡ -->
        <view class="quote-item total">
          <text class="quote-label">{{quoteData.breakdown.grandTotalLabel}}</text>
          <text class="quote-value total-value">Â¥{{quoteData.breakdown.grandTotal}}</text>
        </view>
      </view>

      <!-- è®¡ç®—è¯´æ˜ -->
      <view class="quote-note">
        <text class="note-text">{{quoteData.calculation.note}}</text>
      </view>
    </view>

    <!-- æŠ¥ä»·åŠ è½½çŠ¶æ€ -->
    <view wx:elif="{{quoteLoading}}" class="quote-loading">
      <text>è®¡ç®—æŠ¥ä»·ä¸­...</text>
    </view>

    <!-- æŠ¥ä»·é”™è¯¯çŠ¶æ€ -->
    <view wx:elif="{{quoteError}}" class="quote-error">
      <text>{{quoteError}}</text>
      <button class="retry-btn" bindtap="calculateQuote">é‡æ–°è®¡ç®—</button>
    </view>

    <!-- å°ºå¯¸ä¿¡æ¯ -->
    <view class="size-section">
      <view class="section-header">
        <text class="section-title">å°ºå¯¸ä¿¡æ¯</text>
        <text class="size-guide-btn" bindtap="onShowSizeGuide">å°ºå¯¸ç¤ºæ„å›¾</text>
      </view>
      <!-- äº§å“å°ºå¯¸ -->
      <view class="size-info">
        <view class="size-group">
          <text class="size-group-title">äº§å“å°ºå¯¸</text>
          <view class="size-items">
            <view class="size-item">
              <text class="size-label">é•¿ï¼š</text>
              <text class="size-value">{{sku.width_mm ? (sku.width_mm/10) : (sku.dimensions ? sku.dimensions.length : 0)}}cm</text>
            </view>
            <view class="size-item">
              <text class="size-label">å®½ï¼š</text>
              <text class="size-value">{{sku.depth_mm ? (sku.depth_mm/10) : (sku.dimensions ? sku.dimensions.width : 0)}}cm</text>
            </view>
            <view class="size-item">
              <text class="size-label">é«˜ï¼š</text>
              <text class="size-value">{{sku.height_mm ? (sku.height_mm/10) : (sku.dimensions ? sku.dimensions.height : 0)}}cm</text>
            </view>
          </view>
        </view>
        
        <!-- åŒ…è£…å°ºå¯¸ -->
        <view wx:if="{{sku.package}}" class="size-group">
          <text class="size-group-title">åŒ…è£…å°ºå¯¸</text>
          <view class="size-items">
            <view class="size-item">
              <text class="size-label">é•¿ï¼š</text>
              <text class="size-value">{{sku.package.width_mm/10}}cm</text>
            </view>
            <view class="size-item">
              <text class="size-label">å®½ï¼š</text>
              <text class="size-value">{{sku.package.depth_mm/10}}cm</text>
            </view>
            <view class="size-item">
              <text class="size-label">é«˜ï¼š</text>
              <text class="size-value">{{sku.package.height_mm/10}}cm</text>
            </view>
            <view class="size-item">
              <text class="size-label">é‡é‡ï¼š</text>
              <text class="size-value">{{sku.package.weight_kg}}kg</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç§Ÿèµé…ç½® -->
    <view class="rental-section">
      <text class="section-title">ç§Ÿèµé…ç½®</text>
      <view class="duration-selector">
        <text class="duration-label">ç§Ÿèµæ—¶é•¿ï¼š</text>
        <view class="duration-controls">
          <view class="duration-btn" data-type="minus" bindtap="onDurationChange">-</view>
          <text class="duration-value">{{duration}}ä¸ªæœˆ</text>
          <view class="duration-btn" data-type="plus" bindtap="onDurationChange">+</view>
        </view>
      </view>
      <view class="total-price">
        <text>æ€»è®¡ï¼šÂ¥{{(sku.monthlyPrice || Math.ceil(sku.price/50)) * duration}}</text>
      </view>
    </view>

    <!-- é…é€ä¿¡æ¯ -->
    <view wx:if="{{sku.delivery}}" class="delivery-section">
      <text class="section-title">é…é€ä¿¡æ¯</text>
      <view class="delivery-info">
        <view class="delivery-item">
          <text class="delivery-label">é…é€æ–¹å¼ï¼š</text>
          <text class="delivery-value">{{sku.delivery.modes ? sku.delivery.modes.join('ã€') : ''}}</text>
        </view>
        <view class="delivery-item">
          <text class="delivery-label">é…é€æ—¶é—´ï¼š</text>
          <text class="delivery-value">{{sku.delivery.eta_days ? sku.delivery.eta_days[0] + '-' + sku.delivery.eta_days[1] + 'å¤©' : ''}}</text>
        </view>
        <view class="delivery-item">
          <text class="delivery-label">ä¸Šæ¥¼æœåŠ¡ï¼š</text>
          <text class="delivery-value">{{sku.delivery.upstairs ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}}</text>
        </view>
      </view>
    </view>

    <!-- ä¿å…»è¯´æ˜ -->
    <view wx:if="{{sku.care}}" class="care-section">
      <text class="section-title">ä¿å…»è¯´æ˜</text>
      <text class="care-content">{{sku.care}}</text>
    </view>

    <!-- å¸¸è§é—®é¢˜ -->
    <view wx:if="{{sku.faq && sku.faq.length > 0}}" class="faq-section">
      <text class="section-title">å¸¸è§é—®é¢˜</text>
      <view class="faq-list">
        <view wx:for="{{sku.faq}}" wx:key="q" class="faq-item">
          <text class="faq-question">Q: {{item.q}}</text>
          <text class="faq-answer">A: {{item.a}}</text>
        </view>
      </view>
    </view>

    <!-- æ¨èå•†å“ -->
    <view wx:if="{{recommendations.length > 0}}" class="recommendations-section">
      <text class="section-title">ç›¸å…³æ¨è</text>
      <scroll-view class="recommendations-scroll" scroll-x="true">
        <product-card
          wx:for="{{recommendations}}" 
          wx:key="id"
          product="{{item}}"
          card-type="grid"
          show-favorite="{{true}}"
          bind:cardtap="onRecommendationTap"
        />
      </scroll-view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view wx:if="{{sku}}" class="bottom-actions">
    <view class="action-btn favorite-btn {{isFavorited ? 'favorited' : ''}}" bindtap="onToggleFavorite">
      <text class="action-icon">{{isFavorited ? 'â™¥' : 'â™¡'}}</text>
    </view>
    <button class="action-btn share-btn" open-type="share">åˆ†äº«</button>
    <button class="action-btn primary-btn" bindtap="onCreateOrder">
      ç«‹å³ç§Ÿèµ Â¥{{(sku.monthlyPrice || Math.ceil(sku.price/50)) * duration}}
    </button>
  </view>

  <!-- å°ºå¯¸ç¤ºæ„å›¾å¼¹çª— -->
  <size-sketch
    visible="{{showSizeGuide}}"
    product="{{sku}}"
    mode="modal"
    bind:close="onHideSizeGuide"
  />
</view>
